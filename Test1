#!/usr/bin/env bash

INPUT="$1"

if [[ -z "$INPUT" || ! -f "$INPUT" ]]; then
  echo "Usage: $0 <logfile>"
  exit 1
fi

OUT="timeline-$(basename "$INPUT")"
TMP="/tmp/timeline.$$"

echo "Parsing $INPUT …"

awk '
{
  ts=""; svc=""; cid=""; ip=""; path=""; sc=""; trace=""; msg="EVENT"

  # timestamp (różne formaty)
  if (match($0, /[0-9]{4}-[0-9]{2}-[0-9]{2}[ T][0-9:.]+/, a)) ts=a[0]

  # trace
  if (match($0, /(trace|traceId|trace.id)[^a-zA-Z0-9]*([a-z0-9-]{8,})/, a)) trace=a[2]

  # client
  if (match($0, /(clientId|client.id|customerId)[^a-zA-Z0-9]*([0-9]+)/, a)) cid=a[2]

  # ip
  if (match($0, /([0-9]{1,3}\.){3}[0-9]{1,3}/, a)) ip=a[0]

  # service
  if (match($0, /(service.name|serviceName|app)[^a-zA-Z0-9]*([a-zA-Z0-9-]+)/, a)) svc=a[2]

  # path / url
  if (match($0, /(\/v[0-9]+\/[a-zA-Z0-9\/-]+)/, a)) path=a[1]

  # status
  if (match($0, /(status|status_code)[^0-9]*([0-9]{3})/, a)) sc=a[2]

  # message type
  if ($0 ~ /request/i) msg="→ REQUEST"
  if ($0 ~ /response/i) msg="← RESPONSE"
  if ($0 ~ /error|exception|fail/i) msg="✖ ERROR"

  # linia istotna = ma trace + coś od HTTP
  if (trace != "" && (path != "" || msg != "EVENT"))
    printf "%s|%s|%s|%s|%s|%s|%s|%s\n",
      trace, ts, svc, cid, ip, msg, path, sc
}
' "$INPUT" > "$TMP"

# sort: trace + czas
sort -t'|' -k1,1 -k2,2 "$TMP" > "$TMP.sorted"

# timeline
awk -F'|' '
BEGIN { prev="" }
{
  if ($1 != prev) {
    print ""
    print "════════════════════════════════════"
    print "TRACE: " $1 "  client=" $4 "  ip=" $5
    print "════════════════════════════════════"
    prev=$1
  }

  printf "%s  %-15s %-12s %-25s %s\n",
    $2, $3, $6, $7, ($8 != "" ? "status=" $8 : "")
}
' "$TMP.sorted" | tee "$OUT"

rm -f "$TMP" "$TMP.sorted"

echo ""
echo "Done → $OUT"
